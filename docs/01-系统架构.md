# EVEMakeMoney 后端架构文档

## 项目概述

EVEMakeMoney 是一个基于 EVE Online ESI API 的**前后端分离**商业化分析平台，用于辅助玩家分析游戏内市场数据和制造成本。

### 技术栈

| 层级 | 技术 |
|------|------|
| 前端 | Vue 3 + TypeScript + Vite |
| 后端 | ASP.NET Core 8.0 Web API |
| 数据库 | SQLite (Entity Framework Core) |
| 认证 | JWT Bearer + EVE Online SSO (OAuth2 PKCE) |
| 缓存 | Memory Cache |
| 限流 | AspNetCoreRateLimit |

---

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              前端 (Vue.js)                                  │
│  /login  /character  /blueprint  /market  /manufacturing  /profile         │
└────────────────────────────────┬────────────────────────────────────────────┘
                                 │ HTTP API
                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           后端 (ASP.NET Core)                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Controllers                                    │   │
│  │  AuthController | AssetsController | BlueprintsController           │   │
│  │  MarketController | MarketDataController | SyncController           │   │
│  └────────────────────────────────┬─────────────────────────────────────┘   │
│                                   │                                         │
│  ┌────────────────────────────────▼─────────────────────────────────────┐   │
│  │                         Services                                     │   │
│  │  AuthService | EVESsoService | AssetService                        │   │
│  │  BlueprintCacheService | CostCalculationService | CostBreakdownService│   │
│  │  MarketDataService | MarketPopularityService                        │   │
│  └────────────────────────────────┬─────────────────────────────────────┘   │
│                                   │                                         │
│  ┌────────────────────────────────▼─────────────────────────────────────┐   │
│  │                    Background Services                               │   │
│  │  MarketDataSyncBackgroundService (定时同步市场数据)                  │   │
│  └────────────────────────────────┬─────────────────────────────────────┘   │
└────────────────────────────────────┼──────────────────────────────────────┘
                                     │
              ┌──────────────────────┼──────────────────────┐
              ▼                      ▼                      ▼
    ┌──────────────────┐   ┌──────────────────┐   ┌──────────────────┐
    │   SQLite 数据库  │   │    ESI API       │   │   SDE 文件       │
    │  (市场/用户/蓝图) │   │  (EVE Online)   │   │ (蓝图/类型名称)  │
    └──────────────────┘   └──────────────────┘   └──────────────────┘
```

---

## API 端点总览

### 认证相关 (AuthController)

| 接口 | 方法 | 说明 | 认证 |
|------|------|------|------|
| `/api/auth/register` | POST | 用户注册 | ✗ |
| `/api/auth/login` | POST | 用户登录 | ✗ |
| `/api/auth/refresh` | POST | 刷新Token | ✗ |
| `/api/auth/logout` | POST | 退出登录 | ✓ |
| `/api/auth/me` | GET | 获取当前用户 | ✓ |
| `/api/auth/sso/url` | GET | 获取EVE SSO授权URL | ✓ |
| `/callback` | GET | EVE SSO回调 | ✗ |
| `/api/auth/characters` | GET | 获取绑定角色列表 | ✓ |
| `/api/auth/characters/{id}` | DELETE | 解绑角色 | ✓ |

### 资产相关 (AssetsController)

| 接口 | 方法 | 说明 | 认证 |
|------|------|------|------|
| `/api/assets/{characterId}` | GET | 获取角色资产(含位置) | ✓ |
| `/api/assets/tree/{characterId}` | GET | 资产树形结构 | ✓ |
| `/api/assets/by-location/{characterId}` | GET | 按位置分组资产 | ✓ |
| `/api/assets/summary/{characterId}` | GET | 资产汇总统计 | ✓ |

### 蓝图相关 (BlueprintsController)

| 接口 | 方法 | 说明 | 认证 |
|------|------|------|------|
| `/api/blueprints` | GET | 获取蓝图列表 | ✗ |
| `/api/blueprints/{id}` | GET | 获取单个蓝图 | ✗ |
| `/api/blueprints/calculate` | POST | 计算制造成本 | ✗ |
| `/api/blueprints/{id}/breakdown` | GET | 成本分解树 | ✗ |
| `/api/blueprints/history` | GET | 计算历史记录 | ✓ |

### 市场相关 (MarketController)

| 接口 | 方法 | 说明 | 认证 |
|------|------|------|------|
| `/api/market/popularity/{typeId}` | GET | 单物品热门指数 | ✗ |
| `/api/market/popularity` | GET | 所有物品热门指数 | ✗ |
| `/api/market/popularity/{typeId}/report` | GET | 热门指数报告 | ✗ |

### 市场数据管理 (MarketDataController)

| 接口 | 方法 | 说明 | 认证 |
|------|------|------|------|
| `/api/marketdata/status` | GET | 数据状态 | ✗ |
| `/api/marketdata/fetch-orders/{regionId}` | POST | 抓取订单 | ✓ |
| `/api/marketdata/fetch-history/{regionId}` | POST | 批量抓取历史 | ✓ |
| `/api/marketdata/fetch-history/{regionId}/{typeId}` | POST | 单物品抓取历史 | ✓ |
| `/api/marketdata/calculate-weekly-sales/{regionId}/{typeId}` | POST | 计算周销量 | ✓ |
| `/api/marketdata/prices` | GET | 市场价格 | ✗ |

### 同步触发 (SyncController)

| 接口 | 方法 | 说明 | 认证 |
|------|------|------|------|
| `/api/sync/trigger` | POST | 触发后台同步 | ✓ |

---

## 核心服务说明

### 1. 认证服务

#### AuthService
- 用户注册/登录 (BCrypt 密码哈希)
- JWT Access Token 生成与验证
- Refresh Token 管理

#### EVESsoService
- EVE Online OAuth2 SSO 集成
- PKCE 授权码流程 (安全)
- Token 自动刷新
- 角色绑定/解绑管理

### 2. 资产服务 (AssetService)

```
ESI API (/characters/{id}/assets)
        │
        ▼
    分页获取资产
        │
        ▼
    解析位置类型 (Station/Structure/System)
        │
        ▼
    调用 ESI 获取位置名称
        │
        ▼
    获取物品类型信息 (名称/体积/图标)
        │
        ▼
    获取市场价格
        │
        ▼
    构建资产树 / 按位置分组
```

### 3. 蓝图与成本服务

#### BlueprintCacheService
- 从 SDE 文件加载蓝图数据
- 内存缓存 (1小时滑动 / 24小时绝对)
- 关联中文名称

#### CostCalculationService
- 拓扑排序处理蓝图依赖
- 计算制造成本 (材料 × 单价)
- 计算制造时间 (含各种加成因子)
- 支持 T2 发明/反应成本

#### CostBreakdownService
- 递归构建成本分解树
- 检测循环依赖
- 从市场订单获取材料价格

### 4. 市场数据服务

#### MarketDataService
- 从 ESI 抓取市场订单/历史
- 批量并发抓取
- 计算周销量统计

#### MarketDataSyncBackgroundService
- 后台定时同步服务
- 可配置同步间隔
- 支持手动触发

#### MarketPopularityService
- 分析热门指数 (0-100分)
- 时间聚类分析
- 生成分析报告

---

## 数据库表结构

### 用户相关

| 表名 | 说明 |
|------|------|
| Users | 用户账户 |
| Characters | EVE角色绑定 |

### 市场数据

| 表名 | 说明 |
|------|------|
| MarketOrders | 市场当前挂单 |
| MarketHistory | 历史成交统计 |
| WeeklySales | 周销量汇总 |

### 蓝图相关

| 表名 | 说明 |
|------|------|
| Blueprints | 蓝图ME/TE设置 |
| UserBlueprintSettings | 用户个人蓝图设置 |
| CalculationHistory | 计算历史记录 |

---

## 认证流程

```
用户注册/登录
     │
     ▼
AuthService → JWT Token
     │
     ▼
前端存储 Token
     │
     ▼
请求带 Authorization: Bearer {token}
     │
     ▼
后端验证 Token
     │
     ▼
EVE SSO 授权 (可选)
     │
     ▼
绑定角色 → 获取 ESI 访问令牌
```

---

## 限流配置

| 规则 | 限制 |
|------|------|
| 全局 | 100请求/分钟 |
| 登录 | 10请求/分钟 |
| 注册 | 5请求/小时 |

---

## 相关文档

- [功能文档](功能文档.md) - 核心功能说明
- [市场数据文档](市场数据文档.md) - 数据表结构
- [市场热门指数文档](市场热门指数使用文档.md) - 热门指数分析
