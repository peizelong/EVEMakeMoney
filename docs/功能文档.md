# EVEMakeMoney 功能文档

## 项目概述

EVEMakeMoney 是一个基于 EVE Online ESI API 的 WPF 应用程序，用于辅助玩家分析游戏内市场数据和制造成本，从而做出更好的游戏内经济决策。

---

## 核心功能

### 1. 蓝图数据管理

- **加载蓝图数据**：从 SDE (Static Data Export) 蓝图纸文件中读取蓝图信息
- **ME/TE 设置**：支持为每个蓝图单独设置制造效率 (ME) 和时间效率 (TE)
- **蓝图类型识别**：自动识别 T1 制造、T2 制造、发明、反应等不同类型

### 2. 市场数据获取

- **当前挂单**：从 ESI API 获取指定区域的市场当前挂单
- **历史统计**：获取物品的历史价格和成交量数据
- **周销售汇总**：自动计算周销售统计信息
- **数据存储**：使用 SQLite 本地数据库存储市场数据

### 3. 成本计算

- **制造成本**：计算物品的制造成本（基于市场买单最高价）
- **制造时间**：计算物品的制造时间（递归累加，应用各种时间减免因子）
- **发明成本**：计算 T2 物品的发明成本
- **完整成本链**：显示从原材料到成品的完整成本树和制造时间树
- **批量计算**：支持批量计算多个蓝图的制造成本和制造时间

### 4. 市场热门指数分析

- **订单数据分析**：分析订单数量和近期订单占比
- **供应量分析**：分析挂单总量和近期供应量
- **销售数据分析**：分析历史销量数据
- **时间聚类**：识别集中改单的时间段
- **热门指数计算**：根据多个维度计算热门指数 (0-100分)

---

## 界面功能

### 主界面布局

```
┌──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│  [加载蓝图数据] [加载市场数据] [计算成本] [市场热门指数]  ME: [0] TE: [0] 建筑减免%: [0] 插减免%: [0]                 │
│  工业等级: [5] 高级工业: [5] 反应建筑%: [0] 反应插%: [0] 反应等级: [5]                                                │
├──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│  搜索: [________________________________________]  进度条...                                                        │
├─────────────────────────────────────────────┬──────────────────────────────────────────────────────────────────────────┤
│  蓝图列表                                  │  成本链条                                                            │
│  - 名字                                   │  ┌────────────────────────────────────────────────────────────────┐  │
│  - 蓝图ID                                 │  │ T2 CPU                                                   │  │
│  - Key                                    │  │ ├─ T1 CPU × 2                                           │  │
│  - 最大生产限制                            │  │ └─ 原材料...                                             │  │
│  - ME                                     │  └────────────────────────────────────────────────────────────────┘  │
│  - TE                                     │                                                                              │
│  - 制造成本                               │  热门指数结果                                                         │
│  - 发明成本                               │  ┌────────────────────────────────────────────────────────────────┐  │
│  - 制造时间                               │  │ 热门指数: 78.5/100                                       │  │
│                                           │  │ 总订单数: 156                                            │  │
│                                           │  │ ...                                                      │  │
│                                           │  └────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────┴──────────────────────────────────────────────────────────────────────────┘
```

### 功能按钮

| 按钮 | 功能 |
|------|------|
| 加载蓝图数据 | 从 `sde/blueprints.jsonl` 加载蓝图信息 |
| 加载市场数据 | 从 ESI API 获取市场挂单和历史数据 |
| 计算成本 | 根据当前市场单价计算选中蓝图的制造成本 |
| 市场热门指数 | 分析选中蓝图成品的热门指数 |

### 输入参数

#### 制造活动参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| ME | 材料效率等级 | 0 |
| TE | 时间效率等级 | 0 |
| 建筑减免% | 建筑时间加成（如工程复合体） | 0 |
| 插减免% | 建筑插时间加成（如T2制造时间装置） | 0 |
| 工业等级 | 工业理论技能等级（每级4%减免） | 5 |
| 高级工业 | 高级工业理论技能等级（每级3%减免） | 5 |

#### 反应活动参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| 反应建筑% | 反应建筑时间加成 | 0 |
| 反应插% | 反应建筑插时间加成 | 0 |
| 反应等级 | 反应效率技能等级（每级4%减免） | 5 |

### 搜索功能

支持按蓝图名称或蓝图 ID 搜索过滤蓝图列表。

---

## 数据流程

```
┌──────────────┐    ┌─────────────────┐    ┌────────────────┐
│  SDE 蓝图文件 │───>│  BlueprintLoader │───>│  蓝图列表      │
└──────────────┘    └─────────────────┘    └────────────────┘
                                              │
                                              v
┌──────────────┐    ┌─────────────────┐    ┌────────────────┐
│   ESI API    │───>│ MarketDataService│───>│ SQLite 数据库  │
└──────────────┘    └─────────────────┘    └────────────────┘
                                              │
                                              v
┌──────────────┐    ┌─────────────────┐    ┌────────────────┐
│  市场买单    │<───│ CostCalculation  │<───│ 成本计算服务    │
│  (最高价)    │    │    Service      │    └────────────────┘
└──────────────┘    └─────────────────┘
```

---

## 核心服务

### MarketDataService

负责从 ESI API 获取和存储市场数据。

| 方法 | 说明 |
|------|------|
| `FetchAndSaveMarketOrdersAsync(regionId)` | 获取并保存市场挂单 |
| `GetTypeIdsFromOrdersAsync(regionId)` | 获取所有物品类型 ID |
| `FetchAndSaveMarketHistoryAsync(regionId, typeId)` | 获取历史统计 |
| `CalculateWeeklySalesAsync(regionId, typeId)` | 计算周销售汇总 |

### CostCalculationService

负责计算制造成本和制造时间。

| 方法 | 说明 |
|------|------|
| `CalculateAllCosts(blueprints, me, te, ...)` | 计算所有蓝图成本 |
| `CalculateAllTimes(blueprints, me, te, ...)` | 计算所有蓝图制造时间 |
| `CalculateManufacturingCost(blueprint)` | 计算制造成本 |
| `CalculateManufacturingTime(blueprint)` | 计算制造时间 |
| `GetMarketPrices()` | 获取市场单价（买单最高价） |

### CostBreakdownService

负责生成详细的成本分解树和时间分解树。

| 方法 | 说明 |
|------|------|
| `GetCostBreakdown(blueprintTypeId, blueprints)` | 获取完整成本和时间树 |
| `BuildCostTree()` | 递归构建成本时间树 |
| `CalculateInventionCosts()` | 计算发明成本 |
| `FormatCostTree()` | 格式化输出成本和时间信息 |

### MarketPopularityService

负责市场热门指数分析。

| 方法 | 说明 |
|------|------|
| `Analyze(typeId, regionId)` | 分析单个物品的热门指数 |
| `AnalyzeAll(regionId)` | 批量分析所有物品 |
| `GenerateReport(result)` | 生成分析报告 |

---

## 成本计算说明

### 制造成本计算

**计算公式**：
```
材料成本 = Σ(材料数量 × 材料单价)
单位成本 = 材料成本 / 产出数量
```

- **材料来源**：市场买入订单的最高价
- **ME 因子**：每级减少 1% 材料消耗 (`ME因子 = 1 - ME × 0.01`)
- **T2 蓝图特殊处理**：T2 蓝图制造时，子材料如果是制造品则应用 ME 因子，否则不应用

### 制造时间计算

#### 制造活动时间计算公式

```
最终时间 = 基础时间 × TE因子 × 建筑因子 × 插因子 × 工业因子 × 高级工业因子
```

| 因子 | 计算方式 | 说明 |
|-----|---------|------|
| TE因子 | `1 - TE × 0.02` | 时间效率，每级2% |
| 建筑因子 | `1 - 建筑减免% × 0.01` | 建筑时间加成 |
| 插因子 | `1 - 插减免% × 0.01` | 建筑插时间加成 |
| 工业因子 | `1 - 工业等级 × 0.04` | 工业理论，每级4% |
| 高级工业因子 | `1 - 高级工业等级 × 0.03` | 高级工业理论，每级3% |

#### 反应活动时间计算公式

```
最终时间 = 基础时间 × 反应建筑因子 × 反应插因子 × 反应因子
```

| 因子 | 计算方式 | 说明 |
|-----|---------|------|
| 反应建筑因子 | `1 - 反应建筑% × 0.01` | 反应建筑时间加成 |
| 反应插因子 | `1 - 反应插% × 0.01` | 反应建筑插时间加成 |
| 反应因子 | `1 - 反应等级 × 0.04` | 反应效率，每级4% |

**注意**：反应活动不应用 TE 因子

### 发明成本计算

**计算公式**：
```
发明成本 = 发明材料成本 / 发明成功率 / 产出数量
```

---

## 数据库表

### MarketOrders (市场挂单)

存储从 ESI 获取的市场当前挂单。

### MarketHistory (历史统计)

存储物品的历史价格和成交量。

### WeeklySales (周销售汇总)

存储按周聚合的销售统计。

### Blueprints (蓝图设置)

存储用户设置的 ME/TE 值。

---

## 相关文档

- [市场数据文档](市场数据文档.md) - 数据库表结构和 API 调用说明
- [市场热门指数使用文档](市场热门指数使用文档.md) - 热门指数分析功能详细说明
