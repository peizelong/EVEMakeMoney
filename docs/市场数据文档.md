# 市场数据文档

## 数据表概览

| 表名 | 说明 | 数据来源 |
|------|------|----------|
| `MarketOrders` | 当前市场挂单 | ESI API - `ListOrdersInRegionAsync` |
| `MarketHistory` | 历史市场统计 | ESI API - `ListHistoricalMarketStatisticsInRegionAsync` |
| `WeeklySales` | 周销售汇总 | 基于 `MarketHistory` 计算 |

---

## 1. MarketOrders (市场挂单)

### 表结构

| 字段 | 类型 | 说明 |
|------|------|------|
| OrderId | long | 订单ID (主键) |
| TypeId | long | 物品类型ID |
| RegionId | long | 区域ID |
| SystemId | long | 星系ID |
| LocationId | long | 位置ID (空间站/卫星) |
| IsBuyOrder | bool | 是否为买单 (true=买, false=卖) |
| Price | double | 单价 |
| VolumeRemain | long | 剩余数量 |
| VolumeTotal | long | 总数量 |
| Duration | long | 持续时间 (天) |
| MinVolume | long | 最小购买量 |
| Range | string | 订单范围 |
| Issued | DateTime | 下单时间 |
| FetchedAt | DateTime | 数据获取时间 |

### ESI API 调用

```csharp
_esi.Market.ListOrdersInRegionAsync(regionId)
```

---

## 2. MarketHistory (历史市场统计)

### 表结构

| 字段 | 类型 | 说明 |
|------|------|------|
| Id | long | 主键 |
| TypeId | long | 物品类型ID |
| RegionId | long | 区域ID |
| Date | DateTime | 日期 |
| Average | double | 平均价格 |
| Highest | double | 最高价格 |
| Lowest | double | 最低价格 |
| OrderCount | long | 订单数量 |
| Volume | long | 成交量 |
| FetchedAt | DateTime | 数据获取时间 |

### 索引

```csharp
HasIndex(x => new { x.TypeId, x.RegionId, x.Date })
```

### ESI API 调用

```csharp
_esi.Market.ListHistoricalMarketStatisticsInRegionAsync(regionId, typeId)
```

---

## 3. WeeklySales (周销售汇总)

### 表结构

| 字段 | 类型 | 说明 |
|------|------|------|
| Id | long | 主键 |
| TypeId | long | 物品类型ID |
| RegionId | long | 区域ID |
| Year | int | 年份 |
| WeekNumber | int | 周数 (ISO 8601) |
| TotalVolume | long | 总成交量 |
| AveragePrice | double | 平均价格 |
| HighestPrice | double | 最高价格 |
| LowestPrice | double | 最低价格 |
| OrderCount | long | 订单总数 |
| WeekStart | DateTime | 周开始日期 |
| WeekEnd | DateTime | 周结束日期 |
| UpdatedAt | DateTime | 更新时间 |

### 索引

```csharp
HasIndex(x => new { x.TypeId, x.RegionId, x.Year, x.WeekNumber })
```

### 计算方式

- 按 ISO 8601 周分组
- 聚合该周内所有 `MarketHistory` 数据

---

## 数据获取服务

### MarketDataService 主要方法

| 方法 | 说明 |
|------|------|
| `FetchAndSaveMarketOrdersAsync(regionId)` | 获取并保存指定区域的当前挂单 |
| `GetTypeIdsFromOrdersAsync(regionId)` | 从订单中提取所有物品类型ID |
| `FetchAndSaveMarketHistoryAsync(regionId, typeId)` | 获取指定物品的历史市场统计 |
| `FetchAndSaveAllMarketHistoryAsync(regionId, typeIds)` | 批量获取多个物品的历史数据 |
| `CalculateWeeklySalesAsync(regionId, typeId)` | 计算单个物品的周销售汇总 |
| `CalculateAllWeeklySalesAsync(regionId)` | 计算区域内所有物品的周销售汇总 |
| `GetTypeIdsFromBlueprints(blueprintsFilePath)` | 从蓝图中提取所需材料类型ID |

---

## 成本计算使用的数据

在 `CostCalculationService.cs` 中，`GetMarketPrices()` 方法使用：

```csharp
var buyOrders = _db.MarketOrders
    .Where(x => x.IsBuyOrder == true)
    .GroupBy(x => x.TypeId)
    .Select(g => new {
        TypeId = g.Key,
        MaxPrice = g.Max(x => x.Price)  // 买单最高价
    });
```

**当前成本计算仅使用买单 (Buy Order) 的最高价格**，并未使用历史数据。

---

## 相关文件

| 文件 | 说明 |
|------|------|
| `EVEMakeMoney/src/Data/MarketOrderEntity.cs` | 市场订单实体类 |
| `EVEMakeMoney/src/Data/MarketHistoryEntity.cs` | 历史市场统计实体类 |
| `EVEMakeMoney/src/Data/WeeklySalesEntity.cs` | 周销售汇总实体类 |
| `EVEMakeMoney/src/Data/MarketDataService.cs` | 市场数据获取服务 |
| `EVEMakeMoney/src/Data/CostCalculationService.cs` | 成本计算服务 (使用市场数据) |
| `EVEMakeMoney/src/Data/EVEMakeMoneyDbContext.cs` | 数据库上下文 |
