# 市场热门指数使用文档

## 功能说明

本模块用于分析 EVE Online 市场中物品的热门程度，综合考虑订单数量、供应量、销售数据和交易活跃时间段。

---

## 热门指数指标

| 指标 | 说明 |
|------|------|
| 总订单数 | 该物品的所有市场订单数量 |
| 近7天订单 | 最近7天内新增/修改的订单数量及占比 |
| 总挂单量 | 所有订单的 VolumeRemain 总和（市场总供应量） |
| 近7天挂单量 | 近期订单的 VolumeRemain 总和 |
| 近7天销量 | 最近7天的历史销售总量 |
| 活跃时间段 | 订单最活跃的小时（UTC） |
| 集中改单时段 | 短时间内大量订单集中的时间段 |

---

## 数据结构

### MarketPopularityResult

分析结果对象，包含以下属性：

| 属性 | 类型 | 说明 |
|------|------|------|
| `TypeId` | long | 物品类型 ID |
| `TypeName` | string | 物品名称 |
| `TotalOrders` | long | 总订单数 |
| `RecentOrders` | long | 近7天订单数 |
| `RecentOrdersPercentage` | double | 近7天订单占比 |
| `TotalSupply` | long | 总挂单量（供应量） |
| `RecentSupply` | long | 近7天挂单量 |
| `RecentSupplyPercentage` | double | 近7天挂单量占比 |
| `TotalVolume` | long | 历史销售总量 |
| `RecentVolume` | long | 近7天销量 |
| `HotHours` | List&lt;int&gt; | 最活跃的 3 个小时（UTC） |
| `TimeClusters` | List&lt;IssuedTimeCluster&gt; | 时间聚类（集中改单时段） |
| `PopularityScore` | double | 热门指数（0-100） |

### IssuedTimeCluster

时间聚类对象：

| 属性 | 类型 | 说明 |
|------|------|------|
| `StartTime` | DateTime | 聚类开始时间 |
| `EndTime` | DateTime | 聚类结束时间 |
| `OrderCount` | int | 该时段内的订单数 |
| `Percentage` | double | 占总订单的百分比 |

---

## 使用方法

### 分析单个物品

```csharp
long typeId = 12345;        // 物品类型 ID
long regionId = 10000002;    // 区域 ID（Forge 区域）
int recentDays = 7;          // 定义"近期"为多少天
int clusterHours = 2;        // 时间聚类窗口（小时）

var result = popularityService.Analyze(
    typeId,
    regionId,
    recentDaysThreshold: recentDays,
    clusterHours: clusterHours
);
```

### 生成报告

```csharp
string report = popularityService.GenerateReport(result);
```

报告示例：

```
=== 市场热门指数分析 ===
物品: 某种弹药 (ID: 12345)

热门指数: 78.5/100

--- 订单数据 ---
总订单数: 156
近7天订单: 89 (57.1%)

--- 供应量数据 ---
总挂单量: 45,230
近7天挂单量: 28,500 (63.0%)

--- 销售数据 ---
近7天销量: 12,450

--- 活跃时间段 (UTC) ---
14:00, 15:00, 13:00

--- 集中改单时段 ---
2026-02-17 13:00 ~ 15:30
  订单数: 45 (28.8%)
```

---

## 热门指数计算规则

| 指标 | 权重 | 说明 |
|------|------|------|
| 订单数量 | 最多 25 分 | 总订单数越多分数越高 |
| 挂单供应量 | 最多 25 分 | 使用对数函数计算，避免极端值 |
| 近期订单占比 | 20% | 近期订单占总订单的百分比 |
| 活跃小时数 | 每小时 5 分 | 最多 15 分 |
| 时间聚类占比 | 15% | 最大时间聚类占订单的百分比 |

**计算公式**：
```
热门指数 = min(订单数/10, 25) 
        + min(log10(供应量+1)*3, 25) 
        + 近期订单占比*0.2 
        + 活跃小时数*5 
        + 时间聚类占比*0.15
```

---

## API 调用

### 获取单个物品热门指数

```
GET /api/market/popularity/{typeId}?regionId=10000002
```

### 获取所有物品热门指数

```
GET /api/market/popularity?regionId=10000002&minOrders=5
```

### 生成热门指数报告

```
GET /api/market/popularity/{typeId}/report?regionId=10000002
```

---

## 相关服务

| 文件 | 说明 |
|------|------|
| `Services/MarketPopularityService.cs` | 热门指数分析服务 |
| `Models/MarketPopularityResult.cs` | 分析结果数据模型 |
| `Controllers/MarketController.cs` | API 控制器 |

---

## 注意事项

- 此分析基于**市场快照**数据，建议定期获取订单数据积累更多信息
- 热门指数仅供参考，需结合实际利润空间判断
- 活跃时间为 UTC，注意转换为本地时区
