# 功能文档

## 项目概述

EVEMakeMoney 是一个基于 EVE Online ESI API 的前后端分离商业化分析平台，用于辅助玩家分析游戏内市场数据和制造成本，从而做出更好的游戏内经济决策。

---

## 核心功能

### 1. 用户系统

- **用户注册/登录**：本地账户 + JWT 认证
- **EVE SSO 绑定**：通过 EVE Online OAuth2 授权绑定游戏角色
- **多角色支持**：支持绑定多个 EVE 角色
- **Token 刷新**：自动刷新 JWT 和 ESI 访问令牌

### 2. 资产管理

- **角色资产查询**：获取角色所有资产
- **资产位置解析**：自动解析位置类型 (站点/建筑/星系)
- **资产树形结构**：显示容器嵌套关系
- **按位置分组**：按位置汇总资产价值和数量
- **资产统计**：总数量/总价值/总体积/位置数

### 3. 蓝图数据管理

- **蓝图加载**：从 SDE (Static Data Export) 蓝图纸文件读取
- **蓝图缓存**：内存缓存提高访问速度
- **ME/TE 设置**：支持为每个蓝图单独设置
- **蓝图类型识别**：自动识别 T1/T2/发明/反应

### 4. 成本计算

- **制造成本**：基于市场买单最高价计算
- **制造时间**：递归累加，应用各种时间减免因子
- **发明成本**：计算 T2 物品发明成本
- **反应成本**：计算反应活动成本
- **完整成本链**：显示原材料到成品的完整成本树
- **成本分解**：递归显示各级材料成本

### 5. 市场数据获取

- **市场订单**：从 ESI API 获取指定区域当前挂单
- **历史统计**：获取物品历史价格和成交量
- **周销售汇总**：自动计算周销量统计
- **后台同步**：定时自动抓取市场数据

### 6. 市场热门指数分析

- **订单分析**：订单数量 + 近期订单占比
- **供应量分析**：挂单总量 + 近期供应量
- **销量分析**：历史销量统计
- **时间聚类**：识别集中改单的时间段
- **热门评分**：综合计算热门指数 (0-100分)

---

## 界面功能 (前端 Vue.js)

### 主要页面

| 页面 | 路径 | 说明 |
|------|------|------|
| 登录 | `/login` | 用户登录/EVE SSO 授权 |
| 首页 | `/` | 功能导航 |
| 角色 | `/character` | 角色管理/资产查看 |
| 蓝图 | `/blueprint` | 蓝图列表/成本计算 |
| 市场 | `/market` | 热门指数分析 |
| 制造 | `/manufacturing` | 成本计算/成本分解 |
| 个人 | `/profile` | 用户信息/角色绑定 |

### 角色页面功能

```
┌─────────────────────────────────────────────────────────────────────┐
│  角色列表                           [刷新资产] [+添加角色]           │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐                                   │
│  │ 角色名称   │ │ 角色名称   │                                   │
│  │ 公司/联盟  │ │ 公司/联盟  │                                   │
│  │ [查看资产] │ │ [查看资产] │                                   │
│  └─────────────┘ └─────────────┘                                   │
└─────────────────────────────────────────────────────────────────────┘

资产查看：
├── 全部资产列表
├── 树形视图 (容器嵌套)
├── 按位置分组
└── 资产汇总 (数量/价值/体积)
```

### 蓝图页面功能

```
┌─────────────────────────────────────────────────────────────────────┐
│  搜索: [____________]  页面: [1]/[100]               [计算成本]    │
├─────────────────────────────────────────────────────────────────────┤
│  蓝图列表 (分页)                     │  成本/时间结果                 │
│  ┌───────────────────────────────┐  │  ┌─────────────────────────┐ │
│  │ 蓝图名称                      │  │  │ 制造成本: 1,234,567 ISK │ │
│  │ 蓝图ID: 12345                │  │  │ 制造时间: 4小时30分     │ │
│  │ 类型: T2 制造                │  │  │ 发明成本: 500,000 ISK  │ │
│  │ [查看成本分解]               │  │  └─────────────────────────┘ │
│  └───────────────────────────────┘  │                               │
└─────────────────────────────────────┴───────────────────────────────┘
```

### 成本计算参数

#### 制造活动参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| ME | 材料效率等级 | 0 |
| TE | 时间效率等级 | 0 |
| 建筑减免% | 建筑时间加成 (如工程复合体) | 0 |
| 插减免% | 建筑插时间加成 (如T2制造时间装置) | 0 |
| 工业等级 | 工业理论技能等级 (每级4%减免) | 5 |
| 高级工业 | 高级工业理论技能等级 (每级3%减免) | 5 |

#### 反应活动参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| 反应建筑% | 反应建筑时间加成 | 0 |
| 反应插% | 反应建筑插时间加成 | 0 |
| 反应等级 | 反应效率技能等级 (每级4%减免) | 5 |

---

## 数据流程

```
┌──────────────┐    ┌─────────────────┐    ┌────────────────┐
│ SDE 蓝图文件  │───>│ BlueprintService │───>│ 蓝图缓存       │
└──────────────┘    └─────────────────┘    └────────────────┘
                                                    │
                                                    ▼
┌──────────────┐    ┌─────────────────┐    ┌────────────────┐
│   ESI API    │───>│ MarketDataService│───>│ SQLite 数据库  │
└──────────────┘    └─────────────────┘    └────────────────┘
                                                    │
                                                    ▼
┌──────────────┐    ┌─────────────────┐    ┌────────────────┐
│  市场买单    │<───│CostCalculation   │<───│ 成本计算服务    │
│  (最高价)    │    │    Service      │    └────────────────┘
└──────────────┘    └─────────────────┘
```

---

## 成本计算说明

### 制造成本计算

**计算公式**：
```
材料成本 = Σ(材料数量 × 材料单价)
单位成本 = 材料成本 / 产出数量
```

- **材料来源**：市场买入订单的最高价
- **ME 因子**：每级减少 1% 材料消耗 (`ME因子 = 1 - ME × 0.01`)
- **T2 蓝图特殊处理**：T2 蓝图制造时，只有**发明出该 T2 蓝图的 T1 原型产品**不受 ME 减免

### 制造时间计算

```
最终时间 = 基础时间 × TE因子 × 建筑因子 × 插因子 × 工业因子 × 高级工业因子
```

| 因子 | 计算方式 |
|-----|---------|
| TE因子 | `1 - TE × 0.02` |
| 建筑因子 | `1 - 建筑减免% × 0.01` |
| 插因子 | `1 - 插减免% × 0.01` |
| 工业因子 | `1 - 工业等级 × 0.04` |
| 高级工业因子 | `1 - 高级工业等级 × 0.03` |

### 发明成本计算

```
发明成本 = 发明材料成本 / 发明成功率 / 产出数量
```

---

## 相关文档

- [01-系统架构](01-系统架构.md) - 系统架构和API总览
- [02-市场数据文档](02-市场数据文档.md) - 数据库表结构
- [03-热门指数文档](03-热门指数使用文档.md) - 热门指数分析
