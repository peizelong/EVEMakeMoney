# 市场数据文档

## 数据表概览

| 表名 | 说明 | 数据来源 |
|------|------|----------|
| `MarketOrders` | 当前市场挂单 | ESI API |
| `MarketHistory` | 历史市场统计 | ESI API |
| `WeeklySales` | 周销售汇总 | 基于 `MarketHistory` 计算 |

---

## 1. MarketOrders (市场挂单)

### 表结构

| 字段 | 类型 | 说明 |
|------|------|------|
| OrderId | long | 订单ID (主键) |
| TypeId | long | 物品类型ID |
| RegionId | long | 区域ID |
| SystemId | long | 星系ID |
| LocationId | long | 位置ID (空间站/建筑) |
| IsBuyOrder | bool | 是否为买单 (true=买, false=卖) |
| Price | double | 单价 |
| VolumeRemain | long | 剩余数量 |
| VolumeTotal | long | 总数量 |
| Duration | long | 持续时间 (天) |
| MinVolume | long | 最小购买量 |
| Range | string | 订单范围 |
| Issued | DateTime | 下单时间 |
| FetchedAt | DateTime | 数据获取时间 |

### ESI API 调用

```
GET https://esi.evetech.net/latest/markets/{region_id}/orders/
```

---

## 2. MarketHistory (历史市场统计)

### 表结构

| 字段 | 类型 | 说明 |
|------|------|------|
| Id | long | 主键 |
| TypeId | long | 物品类型ID |
| RegionId | long | 区域ID |
| Date | DateTime | 日期 |
| Average | double | 平均价格 |
| Highest | double | 最高价格 |
| Lowest | double | 最低价格 |
| OrderCount | long | 订单数量 |
| Volume | long | 成交量 |
| FetchedAt | DateTime | 数据获取时间 |

### 索引

```csharp
HasIndex(x => new { x.TypeId, x.RegionId, x.Date })
```

### ESI API 调用

```
GET https://esi.evetech.net/latest/markets/{region_id}/history/?type_id={type_id}
```

---

## 3. WeeklySales (周销售汇总)

### 表结构

| 字段 | 类型 | 说明 |
|------|------|------|
| Id | long | 主键 |
| TypeId | long | 物品类型ID |
| RegionId | long | 区域ID |
| Year | int | 年份 |
| WeekNumber | int | 周数 (ISO 8601) |
| TotalVolume | long | 总成交量 |
| AveragePrice | double | 平均价格 |
| HighestPrice | double | 最高价格 |
| LowestPrice | double | 最低价格 |
| OrderCount | long | 订单总数 |
| WeekStart | DateTime | 周开始日期 |
| WeekEnd | DateTime | 周结束日期 |
| UpdatedAt | DateTime | 更新时间 |

### 索引

```csharp
HasIndex(x => new { x.TypeId, x.RegionId, x.Year, x.WeekNumber })
```

---

## 相关实体类

| 文件 | 说明 |
|------|------|
| `Data/MarketOrderEntity.cs` | 市场订单实体 |
| `Data/MarketHistoryEntity.cs` | 历史统计实体 |
| `Data/WeeklySalesEntity.cs` | 周销量实体 |
| `Data/EVEMakeMoneyDbContext.cs` | 数据库上下文 |

---

## 相关服务

| 服务 | 说明 |
|------|------|
| `MarketDataService` | 市场数据获取/存储 |
| `MarketDataSyncBackgroundService` | 后台定时同步 |
| `CostCalculationService` | 使用市场数据计算成本 |
| `CostBreakdownService` | 成本分解服务 |
